<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - unsubmy.email</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1 class="dashboard-title">unsubmy.email</h1>
        <p class="subtitle">Scan your email accounts for unsubscribe links and manage them all in one place.</p>
        
        <div class="tab-container" id="tabs">
            <!-- Account tabs will be generated here -->
            <div class="tab" id="tab-add-account" onclick="switchTab('add-account')">+ Add Account</div>
        </div>

        <div id="tab-contents">
            <!-- Account tab contents will be generated here -->
            <div class="tab-content" id="content-add-account">
                <div class="form-card">
                    <h3>Add a New Email Account</h3>
                    <select id="add-provider">
                        <option value="gmail">Gmail</option>
                        <option value="outlook">Outlook</option>
                        <option value="other">Other (IMAP)</option>
                    </select>

                    <div id="add-form-gmail">
                        <p>To add a Gmail account, you'll be redirected to Google to sign in securely.</p>
                        <button id="google-signin-btn" class="google-btn">Sign in with Google</button>
                    </div>

                    <div id="add-form-other" style="display:none;">
                        <input type="email" id="add-email" placeholder="Email Address" required>
                        <input type="password" id="add-password" placeholder="Password" required>
                        <div id="add-imap-container">
                            <input type="text" id="add-imap_server" placeholder="IMAP Server (e.g., imap.example.com)">
                        </div>
                        <div class="button-group">
                            <button id="add-test-btn">Test Connection</button>
                            <button id="add-account-btn">Save Account</button>
                        </div>
                    </div>
                    
                    <div id="add-account-status" class="status-message"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="edit-account-modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">&times;</span>
            <h3 id="edit-modal-title">Edit Account</h3>
            <div id="edit-form-container">
                <!-- Form will be dynamically inserted here by JS -->
            </div>
        </div>
    </div>

<script>
    // Global state
    let accounts = {};
    let unsubscribedLogs = {};

    // DOM Elements
    const tabsContainer = document.getElementById('tabs');
    const tabContentsContainer = document.getElementById('tab-contents');
    const addAccountTab = document.getElementById('tab-add-account');

    // ---- Main Initialization ----
    async function initialize() {
        setupEventListeners();
        
        const response = await fetch('/api/accounts');
        const safeAccounts = await response.json();
        
        accounts = safeAccounts;

        // Add existing accounts from the safe list
        for (const email in safeAccounts) {
            await createAccountTab(email);
        }
        
        const firstAccount = Object.keys(safeAccounts)[0] || 'add-account';
        if (document.getElementById(`tab-${firstAccount.replace(/[@.]/g, '-')}`)) {
            switchTab(firstAccount);
        } else {
            switchTab('add-account');
        }
    }

    function setupEventListeners() {
        document.getElementById('add-provider').addEventListener('change', () => {
            const provider = document.getElementById('add-provider').value;
            const isGmail = provider === 'gmail';
            const isOther = provider === 'other';

            document.getElementById('add-form-gmail').style.display = isGmail ? 'block' : 'none';
            document.getElementById('add-form-other').style.display = isGmail ? 'none' : 'block';
            document.getElementById('add-imap-container').style.display = isOther ? 'block' : 'none';
        });

        document.getElementById('google-signin-btn').addEventListener('click', () => {
            window.location.href = '/login/google';
        });

        document.getElementById('add-account-btn').addEventListener('click', handleAddAccount);
        document.getElementById('add-test-btn').addEventListener('click', () => handleTestConnection('add'));
        document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target == document.getElementById('edit-account-modal')) {
                closeModal();
            }
        });
    }

    // ---- Tab and Content Management ----
    function switchTab(email) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        const safeEmailId = email.replace(/[@.]/g, '-');
        document.getElementById(`tab-${safeEmailId}`).classList.add('active');
        document.getElementById(`content-${safeEmailId}`).classList.add('active');
    }

    async function createAccountTab(email) {
        const safeEmailId = email.replace(/[@.]/g, '-');

        // 1. Create Tab
        const tab = document.createElement('div');
        tab.className = 'tab';
        tab.id = `tab-${safeEmailId}`;
        tab.innerHTML = `
            <span class="tab-text">${email}</span>
            <span class="settings-icon">&#9881;</span>
        `;
        tabsContainer.insertBefore(tab, addAccountTab);
        
        tab.querySelector('.tab-text').addEventListener('click', () => switchTab(email));
        tab.querySelector('.settings-icon').addEventListener('click', (e) => {
            e.stopPropagation();
            openEditModal(email);
        });

        // 2. Create Content Pane
        const content = document.createElement('div');
        content.className = 'tab-content';
        content.id = `content-${safeEmailId}`;
        content.innerHTML = `
            <div class="scan-controls">
                <div>
                    <label for="scan-type-${safeEmailId}">Scan by:</label>
                    <select id="scan-type-${safeEmailId}">
                        <option value="number">Number of recent emails</option>
                        <option value="date">Emails since a specific date</option>
                    </select>
                </div>
                <div id="scan-by-number-${safeEmailId}">
                    <label for="num-emails-${safeEmailId}">Number of emails:</label>
                    <input type="number" id="num-emails-${safeEmailId}" value="100" min="1">
                </div>
                <div id="scan-by-date-${safeEmailId}" style="display:none;">
                    <label for="since-date-${safeEmailId}">Scan since:</label>
                    <input type="date" id="since-date-${safeEmailId}">
                </div>
                <div class="scan-button-container">
                    <button id="scan-btn-${safeEmailId}">Scan Now</button>
                    <div id="status-${safeEmailId}" class="status-message"></div>
                </div>
            </div>
            <div class="scan-history-container" id="history-container-${safeEmailId}">
                <h4>Scan History</h4>
                <div id="history-list-${safeEmailId}"></div>
            </div>

            <hr class="separator">

            <div class="results-header">
                <h2>Unsubscription List</h2>
                <div class="results-summary" id="summary-${safeEmailId}"></div>
            </div>

            <div id="results-${safeEmailId}" class="results-container"></div>
        `;
        tabContentsContainer.appendChild(content);

        // Event listener for the new dropdown
        document.getElementById(`scan-type-${safeEmailId}`).addEventListener('change', (e) => {
            const scanType = e.target.value;
            document.getElementById(`scan-by-number-${safeEmailId}`).style.display = scanType === 'number' ? 'block' : 'none';
            document.getElementById(`scan-by-date-${safeEmailId}`).style.display = scanType === 'date' ? 'block' : 'none';
        });

        document.getElementById(`scan-btn-${safeEmailId}`).onclick = () => handleScan(email);
        
        // 3. Fetch and Render Initial Data
        await fetchUnsubscribedLog(email);
        const response = await fetch('/api/results', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email_address: email })
        });
        const data = await response.json();
        renderResults(email, data);
    }

    // ---- API Calls and Handlers ----
    async function handleAddAccount() {
        const provider = document.getElementById('add-provider').value;
        if (provider === 'gmail') {
            // Gmail accounts are added via OAuth redirect, not this form.
            return;
        }

        const email = document.getElementById('add-email').value;
        const password = document.getElementById('add-password').value;
        const imap_server = document.getElementById('add-imap_server').value;
        
        if (!email || !password) {
            return updateStatus('add-account-status', 'Email and password are required.', true);
        }

        const payload = { email_address: email, password, provider, imap_server };
        updateStatus('add-account-status', 'Saving...', false);

        const response = await fetch('/api/accounts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        updateStatus('add-account-status', result.message, !response.ok);

        if (response.ok) {
            accounts[email] = { provider, imap_server }; // Store locally
            await createAccountTab(email);
            switchTab(email);
            // Reset form
            document.getElementById('add-email').value = '';
            document.getElementById('add-password').value = '';
            document.getElementById('add-imap_server').value = '';
            document.getElementById('add-account-status').textContent = '';
        }
    }

    async function handleScan(email) {
        const safeEmailId = email.replace(/[@.]/g, '-');
        const statusDiv = document.getElementById(`status-${safeEmailId}`);
        const scanButton = document.getElementById(`scan-btn-${safeEmailId}`);
        
        const scanType = document.getElementById(`scan-type-${safeEmailId}`).value;
        let scanParams = '';
        if (scanType === 'number') {
            const numEmails = document.getElementById(`num-emails-${safeEmailId}`).value;
            scanParams = `num_emails=${numEmails}`;
        } else {
            const sinceDate = document.getElementById(`since-date-${safeEmailId}`).value;
            if (!sinceDate) {
                updateStatus(statusDiv.id, 'Please select a date.', true);
                return;
            }
            scanParams = `since_date=${sinceDate}`;
        }

        // --- UI Transformation for Progress ---
        scanButton.disabled = true;
        scanButton.style.background = 'linear-gradient(to right, #4CAF50 0%, #ddd 0%)';
        scanButton.textContent = 'Starting...';
        
        const eventSource = new EventSource(`/scan?email_address=${encodeURIComponent(email)}&${scanParams}`);

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.error) {
                updateStatus(statusDiv.id, data.error, true);
                eventSource.close();
                resetScanButton(scanButton);
                return;
            }

            if (data.status === 'complete') {
                updateStatus(statusDiv.id, data.message, false);
                eventSource.close();
                resetScanButton(scanButton);
                // Final results rendering
                renderResults(email, { links: data.links, scan_history: data.scan_history });
                return;
            }
            
            const percentage = (data.progress / data.total) * 100;
            scanButton.style.background = `linear-gradient(to right, #4CAF50 ${percentage}%, #ddd ${percentage}%)`;
            scanButton.textContent = `Scanning... (${data.progress}/${data.total})`;
            updateStatus(statusDiv.id, `Processing: ${data.current_email_subject}`, false);
        };

        eventSource.onerror = function(err) {
            console.error("EventSource failed:", err);
            updateStatus(statusDiv.id, 'An error occurred during scanning.', true);
            eventSource.close();
            resetScanButton(scanButton);
        };
    }

    function resetScanButton(scanButton) {
        scanButton.disabled = false;
        scanButton.style.background = ''; // Reset to CSS default
        scanButton.textContent = 'Scan Now';
    }

    // ---- Edit Modal Functions ----
    function openEditModal(email) {
        const account = accounts[email];
        if (!account) {
            console.error("Account data not found for", email);
            return;
        }
        document.getElementById('edit-modal-title').textContent = `Edit Account: ${email}`;
        
        const isGmail = account.provider === 'gmail';

        const formContainer = document.getElementById('edit-form-container');
        formContainer.innerHTML = `
            <input type="hidden" id="edit-email" value="${email}">
            <label for="edit-provider">Provider</label>
            <select id="edit-provider" ${isGmail ? 'disabled' : ''}>
                <option value="gmail" ${account.provider === 'gmail' ? 'selected' : ''}>Gmail</option>
                <option value="outlook" ${account.provider === 'outlook' ? 'selected' : ''}>Outlook</option>
                <option value="other" ${account.provider === 'other' ? 'selected' : ''}>Other</option>
            </select>
            <div id="edit-password-section" style="display: ${isGmail ? 'none' : 'block'};">
                <label for="edit-password">New Password (leave blank to keep current)</label>
                <input type="password" id="edit-password" placeholder="Enter new password">
            </div>
            <div id="edit-imap-section" style="display: ${account.provider === 'other' ? 'block' : 'none'};">
                <label for="edit-imap_server">IMAP Server</label>
                <input type="text" id="edit-imap_server" value="${account.imap_server || ''}">
            </div>
            <div class="button-group">
                <button id="edit-update-btn">Update</button>
                <button id="edit-delete-btn">Delete Account</button>
            </div>
            <div id="edit-status" class="status-message"></div>
        `;

        if (!isGmail) {
            document.getElementById('edit-provider').onchange = () => {
                const provider = document.getElementById('edit-provider').value;
                document.getElementById('edit-imap-section').style.display = provider === 'other' ? 'block' : 'none';
            };
        }
        
        document.getElementById('edit-update-btn').addEventListener('click', () => handleUpdateAccount(email));
        document.getElementById('edit-delete-btn').addEventListener('click', () => handleDeleteAccount(email));

        document.getElementById('edit-account-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('edit-account-modal').style.display = 'none';
    }

    async function handleUpdateAccount(email) {
        const password = document.getElementById('edit-password').value;
        const provider = document.getElementById('edit-provider').value;
        const imap_server = document.getElementById('edit-imap_server').value;
        
        let payload = { email_address: email, provider, imap_server };
        if (password) {
            payload.password = password;
        }

        const response = await fetch('/api/accounts/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        updateStatus('edit-status', result.message, !response.ok);
        if (response.ok) {
            // update local state
            accounts[email].provider = provider;
            accounts[email].imap_server = imap_server;
            setTimeout(closeModal, 1500);
        }
    }

    async function handleDeleteAccount(email) {
        if (!confirm(`Are you sure you want to delete ${email} and all its data? This cannot be undone.`)) return;
        
        await fetch('/api/accounts/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email_address: email })
        });

        // Reload the page to reflect deletion
        window.location.reload();
    }

    async function handleTestConnection(context) {
        const email = document.getElementById(`${context}-email`).value;
        const password = document.getElementById(`${context}-password`).value;
        const provider = document.getElementById(`${context}-provider`).value;
        const imap_server = document.getElementById(`${context}-imap_server`).value;

        if (!email || !password) {
            return updateStatus(`${context}-account-status`, 'Email and password are required.', true);
        }

        const payload = { email_address: email, password, provider, imap_server };
        updateStatus(`${context}-account-status`, 'Testing...', false);

        const response = await fetch('/api/test_connection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        updateStatus(`${context}-account-status`, result.message, result.status !== 'OK');
    }

    async function fetchUnsubscribedLog(email) {
        const response = await fetch('/api/unsubscribed', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email_address: email })
        });
        unsubscribedLogs[email] = await response.json();
    }

    // ---- UI Rendering ----
    function renderResults(email, data) {
        const safeEmailId = email.replace(/[@.]/g, '-');
        const resultsContainer = document.getElementById(`results-${safeEmailId}`);
        const historyContainer = document.getElementById(`history-list-${safeEmailId}`);
        const summaryContainer = document.getElementById(`summary-${safeEmailId}`);
        const unsubscribed = unsubscribedLogs[email] || {};
        
        const lastScan = (data.scan_history && data.scan_history.length > 0) ? data.scan_history[data.scan_history.length - 1] : null;

        // Render Scan History
        if (data.scan_history && data.scan_history.length > 0) {
            historyContainer.innerHTML = `
                <ul>
                    ${data.scan_history.slice(-5).reverse().map(scan => `
                        <li>
                            <strong>${new Date(scan.scan_date).toLocaleString()}:</strong>
                            ${scan.description} ${scan.date_range} (${scan.new_links_found} new links found)
                        </li>
                    `).join('')}
                </ul>
            `;
        } else {
            historyContainer.innerHTML = '<p>No scans performed yet.</p>';
        }

        // Render Links & Summary
        const links = data.links || {};
        const allLinks = Object.values(links).flat();
        const totalLinks = allLinks.length;
        
        let unsubscribedProviders = 0;
        const domains = Object.keys(links);
        domains.forEach(domain => {
            if (links[domain].some(link => unsubscribed[link.href])) {
                unsubscribedProviders++;
            }
        });

        if (totalLinks > 0) {
            const allDates = allLinks.map(l => new Date(l.date)).filter(d => !isNaN(d));
            const minDate = new Date(Math.min.apply(null, allDates));
            const maxDate = new Date(Math.max.apply(null, allDates));
            summaryContainer.innerHTML = `
                <p>
                    Covering <strong>${totalLinks}</strong> links from <strong>${minDate.toLocaleDateString()}</strong> to <strong>${maxDate.toLocaleDateString()}</strong>.
                    You have unsubscribed from <strong>${unsubscribedProviders} of ${domains.length}</strong> senders.
                    Last updated: <strong>${lastScan ? new Date(lastScan.scan_date).toLocaleString() : 'N/A'}</strong>.
                </p>
            `;
        } else {
            summaryContainer.innerHTML = '';
        }

        if (domains.length === 0) {
            resultsContainer.innerHTML = '<p class="status-message">No unsubscribe links found. Run a scan to begin.</p>';
            return;
        }

        resultsContainer.innerHTML = ''; // Clear previous results
        domains.sort().forEach(domain => {
            const domainBlock = document.createElement('div');
            domainBlock.className = 'domain-block';
            
            const linksForDomain = links[domain];
            
            // Find the latest unsubscribe date for this domain
            let latestUnsubscribeDate = null;
            linksForDomain.forEach(link => {
                if (unsubscribed[link.href]) {
                    const unsubDate = new Date(unsubscribed[link.href].unsubscribed_date);
                    if (!latestUnsubscribeDate || unsubDate > latestUnsubscribeDate) {
                        latestUnsubscribeDate = unsubDate;
                    }
                }
            });

            // Determine domain status icon
            let statusIcon = '<span class="status-icon unsub-none">☐</span>'; // Not unsubscribed
            let statusText = '';
            if (latestUnsubscribeDate) {
                const hasNewerMail = linksForDomain.some(link => !unsubscribed[link.href] && new Date(link.date) > latestUnsubscribeDate);
                if (hasNewerMail) {
                    statusIcon = '<span class="status-icon unsub-failed" title="New email received after unsubscribing.">❗️</span>'; // Failed
                } else {
                    statusIcon = '<span class="status-icon unsub-ok">✅</span>'; // OK
                }
                statusText = ` (Last unsubscribed: ${latestUnsubscribeDate.toLocaleDateString()})`;
            }

            domainBlock.innerHTML = `
                <h3 class="domain-title">${statusIcon} ${domain} (${linksForDomain.length} links)${statusText}</h3>
                <table>
                    <thead><tr><th>Received</th><th>Subject</th><th>Link Text</th><th>Clicked</th></tr></thead>
                    <tbody>
                    </tbody>
                </table>`;

            const tbody = domainBlock.querySelector('tbody');
            linksForDomain
                .sort((a, b) => new Date(b.date) - new Date(a.date)) // Sort by most recent email first
                 .forEach(linkData => {
                    const tr = document.createElement('tr');
                    const isUnsubscribed = unsubscribed[linkData.href];
                    const emailDate = new Date(linkData.date);
                    
                    let warningIcon = '';
                    if (latestUnsubscribeDate && !isUnsubscribed && emailDate > latestUnsubscribeDate) {
                        warningIcon = '<span class="warning-icon" title="A new email was received after you unsubscribed from this sender.">❗️</span>';
                    }

                    tr.innerHTML = `
                        <td>${emailDate.toLocaleDateString()} ${warningIcon}</td>
                         <td>${linkData.subject || 'No Subject'}</td>
                         <td><a href="${linkData.href}" target="_blank" rel="noreferrer noopener">${linkData.text}</a></td>
                         <td class="clicked-mark">
                             ${isUnsubscribed ? '✅' : ''}
                         </td>
                     `;
                    tr.querySelector('a').addEventListener('click', async () => {
                        // Mark as clicked immediately for better UX
                        tr.querySelector('.clicked-mark').innerHTML = '✅';
                        unsubscribed[linkData.href] = { unsubscribed_date: new Date().toISOString() }; // Update local state
                        
                        await fetch('/api/unsubscribe', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email_address: email, href: linkData.href })
                        });
                        // Re-render to update the header status
                        renderResults(email, data);
                    });
                    tbody.appendChild(tr);
            });
            resultsContainer.appendChild(domainBlock);
        });
    }

    // ---- Utility Functions ----
    function updateStatus(elementId, message, isError) {
        const statusDiv = document.getElementById(elementId);
        if (statusDiv) {
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${isError ? 'error' : 'success'}`;
        }
    }

    document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html> 